# 分散アーキテクチャ構想

**注意: このドキュメントは未実装の構想です。**

現在の実装は `tick` コマンドによる一括処理方式です。

## 設計思想: 天から見下ろさない

このシステムには「全員を制御するロジック」が存在しない。

### 現在の実装（中央集権型）

```
[tickコマンド]
     │
     ├─→ NPC1に投稿させる
     ├─→ NPC2に投稿させる
     └─→ NPC3に投稿させる
```

### 目指す姿（分散型）

```
[NPC1] ─→ 自分のファイルを見る ─→ 判断する ─→ 動く
[NPC2] ─→ 自分のファイルを見る ─→ 判断する ─→ 動く
[NPC3] ─→ 自分のファイルを見る ─→ 判断する ─→ 動く
[レビューア] ─→ 巡回する ─→ 判断する ─→ フラグを書く
```

**ファイルが「場」として機能する。** 住人たちはその場を介して間接的に影響し合う。

## 住人の自律動作

各住人は自分の下書きファイルだけを見て、自分で判断する。

```
住人の1サイクル:

1. 自分の下書きファイル (drafts/自分.json) を読む

2. status を確認:
   - "rejected" → 理由を読む → 反省 → 新しい投稿を生成 → ファイルに書く
   - "posted" or 空 → 新しい投稿を生成 → ファイルに書く
   - "approved" → 投稿時間か確認 → 時間なら投稿 → status を "posted" に
   - "pending" → 何もしない（レビュー待ち）

3. 次のサイクルまで待つ
```

## レビューアの巡回動作

```
レビューアの1サイクル:

1. drafts/ ディレクトリを巡回
2. status: "pending" のファイルを見つける
3. 内容を読む
4. NGルールに照らしてチェック
5. 判定:
   - OK → status: "approved"
   - NG → status: "rejected", rejected_reason: "..."
6. 次のファイルへ
```

## 実行モデル

各プロセスは独立して動く。中央コントローラーは存在しない。

```
[住人1] ──┐
[住人2] ──┤
[住人3] ──┼──→ それぞれ独立して tick() を実行
  ...     │
[住人N] ──┤
[レビューア] ─┤
[記者] ────┘
```

実装上は1つのPythonプロセスで動かすが、論理的には各住人が独立している。

## 構想のメリット

1. **スケーラビリティ**: 住人数が増えても並列実行可能
2. **独立性**: 1人の障害が全体に波及しない
3. **リアリティ**: 各住人が自律的に見える
4. **拡張性**: 新しい住人タイプを追加しやすい

## 現状との差異

| 項目 | 現状 | 構想 |
|------|------|------|
| 実行制御 | tickコマンドが全員を順次処理 | 各NPCが独立して動作 |
| ファイル | 投稿キュー（pending.json等） | 個人の下書きファイル |
| 同期 | コマンド実行単位 | ファイルベースの非同期 |
